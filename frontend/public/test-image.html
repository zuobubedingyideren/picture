<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡åŠ è½½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        img {
            max-width: 300px;
            max-height: 200px;
            border: 2px solid #ccc;
            margin: 10px 0;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .info {
            color: blue;
        }
    </style>
</head>
<body>
    <h1>å›¾ç‰‡åŠ è½½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. ç›´æ¥COSå›¾ç‰‡æµ‹è¯•</h2>
        <p>URL: <span id="cos-url">https://picture-1356335042.cos.ap-chongqing.myqcloud.com/public/1955263849267466241/2025-08-28_8jMkDr6jvDbp0UCc.webp</span></p>
        <img id="cos-img" src="https://picture-1356335042.cos.ap-chongqing.myqcloud.com/public/1955263849267466241/2025-08-28_8jMkDr6jvDbp0UCc.webp" alt="COSå›¾ç‰‡">
        <div id="cos-result">åŠ è½½ä¸­...</div>
    </div>
    
    <div class="test-section">
        <h2>2. ä»£ç†å›¾ç‰‡æµ‹è¯•</h2>
        <p>URL: <span id="proxy-url">http://localhost:8123/api/picture/proxy?url=...</span></p>
        <img id="proxy-img" alt="ä»£ç†å›¾ç‰‡">
        <div id="proxy-result">å‡†å¤‡åŠ è½½...</div>
    </div>
    
    <div class="test-section">
        <h2>3. Fallbackæœºåˆ¶æµ‹è¯•</h2>
        <img id="fallback-img" alt="Fallbackæµ‹è¯•å›¾ç‰‡">
        <div id="fallback-result">å‡†å¤‡æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
        <h2>4. æ§åˆ¶å°æ—¥å¿—</h2>
        <div id="console-log"></div>
    </div>

    <script>
        const cosUrl = 'https://picture-1356335042.cos.ap-chongqing.myqcloud.com/public/1955263849267466241/2025-08-28_8jMkDr6jvDbp0UCc.webp';
        const proxyUrl = `http://localhost:8123/api/picture/proxy?url=${encodeURIComponent(cosUrl)}`;
        
        function log(message, type = 'info') {
            console.log(message);
            const logDiv = document.getElementById('console-log');
            const p = document.createElement('p');
            p.className = type;
            p.textContent = new Date().toLocaleTimeString() + ': ' + message;
            logDiv.appendChild(p);
        }
        
        // 1. æµ‹è¯•ç›´æ¥COSå›¾ç‰‡
        const cosImg = document.getElementById('cos-img');
        const cosResult = document.getElementById('cos-result');
        
        cosImg.onload = function() {
            cosResult.innerHTML = '<span class="success">âœ… COSå›¾ç‰‡åŠ è½½æˆåŠŸ</span>';
            log('âœ… COSå›¾ç‰‡åŠ è½½æˆåŠŸ', 'success');
        };
        
        cosImg.onerror = function(e) {
            cosResult.innerHTML = '<span class="error">âŒ COSå›¾ç‰‡åŠ è½½å¤±è´¥</span>';
            log('âŒ COSå›¾ç‰‡åŠ è½½å¤±è´¥: ' + e.type, 'error');
            
            // å¼€å§‹æµ‹è¯•ä»£ç†å›¾ç‰‡
            testProxyImage();
        };
        
        // 2. æµ‹è¯•ä»£ç†å›¾ç‰‡
        function testProxyImage() {
            const proxyImg = document.getElementById('proxy-img');
            const proxyResult = document.getElementById('proxy-result');
            const proxyUrlSpan = document.getElementById('proxy-url');
            
            proxyUrlSpan.textContent = proxyUrl;
            proxyResult.innerHTML = '<span class="info">ğŸ”„ æ­£åœ¨åŠ è½½ä»£ç†å›¾ç‰‡...</span>';
            log('ğŸ”„ å¼€å§‹æµ‹è¯•ä»£ç†å›¾ç‰‡: ' + proxyUrl, 'info');
            
            proxyImg.onload = function() {
                proxyResult.innerHTML = '<span class="success">âœ… ä»£ç†å›¾ç‰‡åŠ è½½æˆåŠŸ</span>';
                log('âœ… ä»£ç†å›¾ç‰‡åŠ è½½æˆåŠŸ', 'success');
            };
            
            proxyImg.onerror = function(e) {
                proxyResult.innerHTML = '<span class="error">âŒ ä»£ç†å›¾ç‰‡åŠ è½½å¤±è´¥</span>';
                log('âŒ ä»£ç†å›¾ç‰‡åŠ è½½å¤±è´¥: ' + e.type, 'error');
            };
            
            proxyImg.src = proxyUrl;
        }
        
        // 3. æµ‹è¯•Fallbackæœºåˆ¶
        function testFallback() {
            const fallbackImg = document.getElementById('fallback-img');
            const fallbackResult = document.getElementById('fallback-result');
            
            let attemptedProxy = false;
            
            function tryOriginal() {
                fallbackResult.innerHTML = '<span class="info">ğŸ”„ å°è¯•åŠ è½½åŸå§‹COSå›¾ç‰‡...</span>';
                log('ğŸ”„ Fallbackæµ‹è¯•: å°è¯•åŸå§‹å›¾ç‰‡', 'info');
                
                fallbackImg.onload = function() {
                    fallbackResult.innerHTML = '<span class="success">âœ… Fallbackæµ‹è¯•: åŸå§‹å›¾ç‰‡æˆåŠŸ</span>';
                    log('âœ… Fallbackæµ‹è¯•: åŸå§‹å›¾ç‰‡åŠ è½½æˆåŠŸ', 'success');
                };
                
                fallbackImg.onerror = function() {
                    if (!attemptedProxy) {
                        attemptedProxy = true;
                        tryProxy();
                    } else {
                        fallbackResult.innerHTML = '<span class="error">âŒ Fallbackæµ‹è¯•: æ‰€æœ‰æ–¹å¼éƒ½å¤±è´¥</span>';
                        log('âŒ Fallbackæµ‹è¯•: æ‰€æœ‰åŠ è½½æ–¹å¼éƒ½å¤±è´¥', 'error');
                    }
                };
                
                fallbackImg.src = cosUrl;
            }
            
            function tryProxy() {
                fallbackResult.innerHTML = '<span class="info">ğŸ”„ Fallback: å°è¯•ä»£ç†å›¾ç‰‡...</span>';
                log('ğŸ”„ Fallbackæµ‹è¯•: å°è¯•ä»£ç†å›¾ç‰‡', 'info');
                
                fallbackImg.onload = function() {
                    fallbackResult.innerHTML = '<span class="success">âœ… Fallbackæµ‹è¯•: ä»£ç†å›¾ç‰‡æˆåŠŸ</span>';
                    log('âœ… Fallbackæµ‹è¯•: ä»£ç†å›¾ç‰‡åŠ è½½æˆåŠŸ', 'success');
                };
                
                fallbackImg.onerror = function() {
                    fallbackResult.innerHTML = '<span class="error">âŒ Fallbackæµ‹è¯•: ä»£ç†å›¾ç‰‡ä¹Ÿå¤±è´¥</span>';
                    log('âŒ Fallbackæµ‹è¯•: ä»£ç†å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                };
                
                fallbackImg.src = proxyUrl;
            }
            
            tryOriginal();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æµ‹è¯•
        window.onload = function() {
            log('ğŸ”§ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æµ‹è¯•', 'info');
            
            // å»¶è¿Ÿå¯åŠ¨fallbackæµ‹è¯•
            setTimeout(testFallback, 2000);
        };
    </script>
</body>
</html>